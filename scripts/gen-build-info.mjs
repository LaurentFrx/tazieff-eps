import { execSync } from "node:child_process";
import { mkdirSync, readFileSync, writeFileSync } from "node:fs";
import { join } from "node:path";

const outputDir = join(process.cwd(), "src", "lib");
const outputPath = join(outputDir, "buildInfo.ts");

function runGit(command) {
  return execSync(command, { stdio: ["ignore", "pipe", "ignore"] })
    .toString()
    .trim();
}

function normalizeString(value) {
  if (!value || value.trim().length === 0) {
    return "";
  }

  return value.trim();
}

function getEnvLabel() {
  if (process.env.NODE_ENV === "development") {
    return "local";
  }

  const env = normalizeString(process.env.VERCEL_ENV);
  if (env === "production") {
    return "production";
  }
  if (env === "preview" || env === "development") {
    return "preview";
  }
  return "local";
}

function getAppVersion() {
  const pkgPath = join(process.cwd(), "package.json");
  const pkg = JSON.parse(readFileSync(pkgPath, "utf8"));

  return typeof pkg.version === "string" ? pkg.version : "0.0.0";
}

function getGitShaShort() {
  const vercelSha = normalizeString(process.env.VERCEL_GIT_COMMIT_SHA);
  if (vercelSha) {
    return vercelSha.slice(0, 7);
  }

  try {
    return runGit("git rev-parse --short HEAD") || "unknown";
  } catch {
    return "unknown";
  }
}

const buildTimeIso = new Date().toISOString();
const buildInfo = {
  envLabel: getEnvLabel(),
  appVersion: getAppVersion(),
  gitShaShort: getGitShaShort(),
  buildTimeIso,
};

console.log("[build-info] buildTimeIso=", buildTimeIso);

const fileContents = `// This file is auto-generated by scripts/gen-build-info.mjs\n` +
  `export const buildInfo = {\n` +
  `  envLabel: ${JSON.stringify(buildInfo.envLabel)},\n` +
  `  appVersion: ${JSON.stringify(buildInfo.appVersion)},\n` +
  `  gitShaShort: ${JSON.stringify(buildInfo.gitShaShort)},\n` +
  `  buildTimeIso: ${JSON.stringify(buildInfo.buildTimeIso)},\n` +
  `} as const;\n`;

mkdirSync(outputDir, { recursive: true });
writeFileSync(outputPath, fileContents, "utf8");
